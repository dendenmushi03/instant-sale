<!doctype html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title><%= og.title %></title>
  <meta name="description" content="<%= og.desc %>" />

  <!-- Open Graph -->
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Instant Sale" />
  <meta property="og:title" content="<%= og.title %>" />
  <meta property="og:description" content="<%= og.desc %>" />
  <meta property="og:image" content="<%= og.image %>" />
  <meta property="og:image:secure_url" content="<%= og.image %>" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:url" content="<%= og.url %>" />
  <link rel="canonical" href="<%= og.url %>" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="<%= og.title %>" />
  <meta name="twitter:description" content="<%= og.desc %>" />
  <meta name="twitter:image" content="<%= og.image %>" />
  <meta name="twitter:image:alt" content="<%= og.title %>" />

  <link rel="stylesheet" href="/public/style.css" />
</head>

<body class="layout">

<header class="nav">
  <a class="nav__brand" href="/">
<img class="nav__logo" src="/public/logo.png" alt="Instant Sale"
     loading="eager" decoding="async" />
    <span class="nav__brandText">Instant Sale</span>
  </a>
  <nav class="nav__right">
    <% if (me) { %>
      <span class="nav__user"><%= me.name || me.email %></span>
      <form method="post" action="/logout" class="inline">
        <button class="btn btn--ghost">ログアウト</button>
      </form>
    <% } else { %>
      <a class="btn btn--ghost" href="/auth/google">Googleでログイン</a>
    <% } %>
  </nav>
</header>
  
  <main class="container">
    <article class="product">

<div class="product-imageWrap" id="openViewer">
  <img class="product-image"
       src="<%= displayImagePath %>"
       alt="<%= item.title %>"
       loading="lazy"
       decoding="async"
       onerror="this.style.display='none'"
  />
</div>

<!-- ライトボックス（ページ内等倍ビュー） -->
<div id="viewer" class="lightbox" hidden aria-modal="true" role="dialog" aria-label="等倍表示">
  <button class="lightbox__close" aria-label="閉じる">×</button>
  <div class="lightbox__inner">
    <!-- 表示時に src を差す（初回の白画面と事前縮小を防ぐ） -->
    <img id="viewerImg" class="lightbox__img" src="" alt="<%= item.title %> 等倍表示" />
  </div>
  <!-- 等倍⇄画面フィットの切替ボタン -->
  <button class="lightbox__fit" type="button" aria-pressed="false" title="画面に収める/等倍を切替">Fit</button>
</div>
      
      <div class="product-info">
        <h1><%= item.title %></h1>
        <% if (item.creatorName) { %><div class="muted">by <%= item.creatorName %></div><% } %>
<div class="price"><%= item.price.toLocaleString('ja-JP') %> 円</div>

        <% if (sellerLegal) { %>
  <div class="card" style="margin:12px 0;">
    <div class="muted" style="margin-bottom:6px;">販売事業者に関する表示（特定商取引法）</div>
    <ul class="plain">
      <li><strong>販売業者</strong>：<%= sellerLegal.name %></li>
      <% if (sellerLegal.responsible) { %><li><strong>運営責任者</strong>：<%= sellerLegal.responsible %></li><% } %>
      <li><strong>所在地</strong>：<%= sellerLegal.address %></li>
      <% if (sellerLegal.phone) { %><li><strong>電話番号</strong>：<%= sellerLegal.phone %></li><% } %>
      <li><strong>メール</strong>：<%= sellerLegal.email %></li>
      <% if (sellerLegal.website) { %><li><strong>サイト</strong>：<a href="<%= sellerLegal.website %>" target="_blank" rel="noopener">開く</a></li><% } %>
      <% if (sellerLegal.invoiceRegNo) { %><li><strong>適格請求書番号</strong>：<%= sellerLegal.invoiceRegNo %></li><% } %>
    </ul>
  </div>
<% } %>

        <div class="muted">※税込表示</div>

        <%
// 販売者名の表示ロジック（null安全）
// 1) sellerLegal.name（事業者名）
// 2) seller.legal.name → seller.name → seller.email
// 3) それも無ければ '—'
const sellerDisplayName =
  (sellerLegal && sellerLegal.name) ? sellerLegal.name :
  (seller && seller.legal && seller.legal.name) ? seller.legal.name :
  (seller && (seller.name || seller.email)) ? (seller.name || seller.email) :
  '—';
%>

<div class="muted">
  販売事業者： <%= sellerDisplayName %>
  （<a href="<%= tokushohoUrl %>" rel="nofollow">特定商取引法に基づく表示</a>）
</div>

<div class="muted" style="margin-top:8px;">
  デジタル商品のため、購入後のキャンセルは原則できません。誤課金・ファイル不具合時はお問い合わせください。
</div>

          <% if (typeof connect !== 'undefined' && connect && (!connect.hasAccount || !connect.payoutsEnabled)) { %>
    <div class="card error" style="background:#fffaf0; border:1px solid #ffe6b3; padding:12px; margin:12px 0;">
      <strong>（オーナー向けの注意）</strong><br>
      この商品は売上の受取設定が完了していません。<br>
      <a href="/connect/onboard">こちら</a> から Stripe で振込口座の登録を行ってください。
    </div>
  <% } %>

          <form id="checkoutForm" action="/checkout/<%= item.slug %>" method="post" target="_top" novalidate>
          <button id="checkoutBtn" class="btn primary" type="submit" aria-live="polite">
            高解像度を購入してダウンロード
          </button>
        </form>

<section class="card" style="margin-top:16px">
  <h2>利用許諾</h2>

  <% 
    // 旧enum(editorial等)が残っていても安全に表示できるよう互換マッピング
    const lpRaw = (item.licensePreset || 'standard');
    const L = (['personal','standard','commercial-lite','exclusive'].includes(lpRaw))
      ? lpRaw
      : (lpRaw === 'editorial' ? 'personal' : 'standard'); // 互換: editorial→商用不可

    // 表示用ヘルパ（行のクラスを返す）
    const cls = (key) => (L === key ? 'licenseRow is-active' : 'licenseRow is-inactive');
  %>

  <div class="licenseList licenseList--view">
    <!-- 商用不可（= personal） -->
    <div class="<%= cls('personal') %>">
      <div class="licenseBullet" aria-hidden="true"></div>
      <div class="licenseMain">
        <div class="licenseTitle">商用不可</div>
        <div class="licenseDesc">個人利用のみ可。用途例：SNSアイコン、個人ブログ、壁紙など</div>
      </div>
    </div>

    <!-- 商用可（= standard） -->
    <div class="<%= cls('standard') %>">
      <div class="licenseBullet" aria-hidden="true"></div>
      <div class="licenseMain">
        <div class="licenseTitle">商用可</div>
        <div class="licenseDesc">用途例：SNS投稿、企業SNS、HP素材など</div>
      </div>
    </div>

    <!-- 一部商用可（= commercial-lite） -->
    <div class="<%= cls('commercial-lite') %>">
      <div class="licenseBullet" aria-hidden="true"></div>
      <div class="licenseMain">
        <div class="licenseTitle">一部商用可</div>
        <div class="licenseDesc">用途例：同人誌・グッズ等の小規模販売（大量生産・ロゴ利用は不可）</div>
      </div>
    </div>

    <!-- 完全商用可（= exclusive） -->
    <div class="<%= cls('exclusive') %>">
      <div class="licenseBullet" aria-hidden="true"></div>
      <div class="licenseMain">
        <div class="licenseTitle">完全商用可</div>
        <div class="licenseDesc">用途例：広告素材、パッケージ販売</div>
      </div>
    </div>
  </div>

  <!-- 追加情報（AI/追記事項）は従来どおり表示 -->
  <ul class="plain" style="margin-top:8px">
    <% if (item.aiGenerated) { %>
      <li><strong>AI生成</strong>：含む<% if (item.aiModelName) { %>（<%= item.aiModelName %>）<% } %></li>
    <% } %>
    <% if (item.licenseNotes) { %>
      <li><strong>追記事項</strong>：<%= item.licenseNotes %></li>
    <% } %>
  </ul>

  <p class="muted" style="margin-top:8px;">
    ※ 共通ルールは <a href="/image-license" target="_blank" rel="noopener">画像ライセンスポリシー</a> を参照。
  </p>
</section>

        <p class="hint">決済はStripe（カード）で安全に処理されます。</p>
      </div>
    </article>
  </main>

<script nonce="<%= cspNonce %>">

(function(){
  var opener = document.getElementById('openViewer');
  var modal  = document.getElementById('viewer');
  if(!opener || !modal) return;

  var btnClose = modal.querySelector('.lightbox__close');
  var btnFit   = modal.querySelector('.lightbox__fit');
  var img      = document.getElementById('viewerImg');
  var srcFull  = "/view/<%= item.slug %>";   // 等倍生成エンドポイント
  var fitMode  = false; // false=等倍, true=画面フィット

  // 事前プリロードで初回の空白を防ぐ
  var pre = new Image(); pre.src = srcFull;

  function applyMode(){
    if (fitMode) {
      img.style.maxWidth  = "100%";
      img.style.maxHeight = "100%";
      img.style.width = "auto"; img.style.height = "auto";
      btnFit && btnFit.setAttribute('aria-pressed','true');
    } else {
      img.style.maxWidth  = "none";   // ← 等倍の要点
      img.style.maxHeight = "none";
      img.style.width = "auto"; img.style.height = "auto";
      btnFit && btnFit.setAttribute('aria-pressed','false');
    }
  }

  function show(){
    if (img.getAttribute('src') !== srcFull) img.setAttribute('src', srcFull);
    fitMode = false; applyMode();     // いつも等倍で開く
try {
    var url = '/view/<%= item.slug %>?t=' + Date.now(); // キャッシュ回避
    var img = modal.querySelector('.lightbox__img');
    if (img && img.src !== url) img.src = url;
  } catch(_) {}
  modal.hidden = false;
  document.body.style.overflow = 'hidden';

    var inner = modal.querySelector('.lightbox__inner');
    if (inner) inner.scrollTo({left:0, top:0, behavior:'auto'}); // 左上から開始
  }

  function hide(){
    modal.hidden = true;
    document.body.style.overflow = '';
  }

  opener.addEventListener('click', function(e){ e.preventDefault(); show(); });
  btnClose.addEventListener('click', hide);
  modal.addEventListener('click', function(e){ if(e.target === modal) hide(); });
  window.addEventListener('keydown', function(e){ if(e.key === 'Escape') hide(); });

  // ダブルタップ/ダブルクリックで 等倍⇄フィット
  var lastTap = 0;
  modal.addEventListener('touchend', function(e){
    var now = Date.now();
    if (now - lastTap < 350) { fitMode = !fitMode; applyMode(); e.preventDefault(); }
    lastTap = now;
  }, {passive:false});
  modal.addEventListener('dblclick', function(){ fitMode = !fitMode; applyMode(); });

  btnFit && btnFit.addEventListener('click', function(){ fitMode = !fitMode; applyMode(); });
})();

</script>

<footer class="site-footer">
  <div class="footer__links">
    <a href="/terms">利用規約</a>
    <span class="dot">•</span>
    <a href="/privacy">プライバシーポリシー</a>
    <span class="dot">•</span>
    <a href="/tokushoho">特定商取引法に基づく表記</a>
  </div>
  <div class="footer__copy">© <%= new Date().getFullYear() %> Instant Sale</div>
</footer>

<script nonce="<%= cspNonce %>">
  (function () {
    var form = document.getElementById('checkoutForm');
    var btn  = document.getElementById('checkoutBtn');
    if (!form || !btn) return;

    // 二度押し防止 & 視覚的なフィードバック
    form.addEventListener('submit', function () {
      try {
        btn.disabled = true;
        btn.style.opacity = '0.75';
        btn.textContent = 'Stripeに移動中…';
      } catch (_) {}
      // 念のため、最上位フレームへ遷移を強制（iOSアプリ内ブラウザ対策）
      try {
        form.setAttribute('target', '_top');
      } catch (_) {}
    }, { once: true });
  })();
</script>

</body>
</html>

