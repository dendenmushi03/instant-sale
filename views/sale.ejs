<!doctype html>
<html lang="<%= lng || 'ja' %>">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title><%= og.title %></title>
  <meta name="description" content="<%= og.desc %>" />

  <!-- Open Graph -->
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Instant Sale" />
  <meta property="og:title" content="<%= og.title %>" />
  <meta property="og:description" content="<%= og.desc %>" />
  <meta property="og:image" content="<%= og.image %>" />
  <meta property="og:image:secure_url" content="<%= og.image %>" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:url" content="<%= og.url %>" />
  <link rel="canonical" href="<%= og.url %>" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="<%= og.title %>" />
  <meta name="twitter:description" content="<%= og.desc %>" />
  <meta name="twitter:image" content="<%= og.image %>" />
  <meta name="twitter:image:alt" content="<%= og.title %>" />

<link rel="stylesheet" href="/public/style.css?v=<%= assetVer %>" />
<style>
  /* 購入ボタンとの間に余白をつくる */
  .section-license { margin-top: 12px; }
  @media (min-width: 768px) {
    .section-license { margin-top: 16px; }
  }
  .section-license .pill {
    display:inline-block; padding:.25rem .6rem; border-radius:9999px;
    background:#223; color:#fff; font-weight:600;
  }
  .section-license .license-desc,
  .section-license .license-notes,
  .section-license .license-ai,
  .section-license .license-policy {
    margin:.4rem 0; opacity:.9;
  }

</style>

<style>
  .lang-select{ margin-left:12px }
  .lang-select__control{
    appearance:none; -webkit-appearance:none; -moz-appearance:none;
    background:#0f172a; border:1px solid #243246; color:#fff;
    padding:.55rem .9rem; border-radius:12px; font-weight:700;
  }
  /* スクリーンリーダー用 */
  .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }
</style>

</head>

<body class="layout">

<header class="nav">
  <a class="nav__brand" href="/">
<img class="nav__logo" src="/public/logo.png" alt="Instant Sale"
     loading="eager" decoding="async" />
<span class="nav__brandText"><%= t('brand') %></span>
    </a>
  <nav class="nav__right">
    <% if (me) { %>
      <span class="nav__user"><%= me.name || me.email %></span>

<form method="post" action="/logout" class="inline">
  <input type="hidden" name="_csrf" value="<%= csrfToken %>">
  <button class="btn btn--ghost"><%= t('nav.logout') %></button>
</form>

      <% } else { %>
<a class="btn btn--ghost" href="/auth/google"><%= t('nav.login_google') %></a>
      <% } %>

<form class="lang-select" action="/lang" method="get" aria-label="Language">
  <input type="hidden" name="return" value="<%= currentPath %>">
  <label for="langSelect" class="sr-only">Language</label>
  <select id="langSelect" name="lng" class="lang-select__control">
    <option value="ja" <%= lng==='ja' ? 'selected' : '' %>>日本語</option>
    <option value="en" <%= lng==='en' ? 'selected' : '' %>>English</option>
  </select>
  <noscript><button class="btn btn--ghost" type="submit">OK</button></noscript>
</form>

    </nav>
</header>
      
  <main class="container">
    <article class="product">

<div class="product-imageWrap" id="openViewer">
  <img
    class="product-image"
    src="/view/<%= item.slug %>"
    alt="<%= item.title %>"
    loading="lazy"
    decoding="async"
    onerror="this.src='/previews/<%= item.slug %>-preview.jpg'"
  />
</div>

<!-- ライトボックス（ページ内等倍ビュー） -->
<div id="viewer" class="lightbox" hidden aria-modal="true" role="dialog" aria-label="等倍表示">
  <button class="lightbox__close" aria-label="閉じる">×</button>
  <div class="lightbox__inner">
    <!-- 表示時に src を差す（初回の白画面と事前縮小を防ぐ） -->
    <img id="viewerImg" class="lightbox__img" src="" alt="<%= item.title %> 等倍表示" />
  </div>
  <!-- 等倍⇄画面フィットの切替ボタン -->
  <button class="lightbox__fit" type="button" aria-pressed="false" title="画面に収める/等倍を切替">Fit</button>
</div>
      
      <div class="product-info">
        <h1><%= item.title %></h1>
        <% if (item.creatorName) { %><div class="muted">by <%= item.creatorName %></div><% } %>
<% const locale = (lng === 'en' ? 'en-US' : 'ja-JP'); %>
<div class="price">¥<%= item.price.toLocaleString(locale) %></div>

<div class="muted"><%= t('product.tax_note') %></div>

        <%
// 販売者名の表示ロジック（null安全）
// 1) sellerLegal.name（事業者名）
// 2) seller.legal.name → seller.name → seller.email
// 3) それも無ければ '—'
const sellerDisplayName =
  (sellerLegal && sellerLegal.name) ? sellerLegal.name :
  (seller && seller.legal && seller.legal.name) ? seller.legal.name :
  (seller && (seller.name || seller.email)) ? (seller.name || seller.email) :
  '—';
%>

<div class="muted">
  <%= t('product.seller_label') %> <%= sellerDisplayName %>
  （<a href="<%= tokushohoUrl %>" rel="nofollow"><%= t('product.legal_link') %></a>）
</div>

<div class="muted" style="margin-top:8px;">
  <%= t('product.download_note') %>
</div>

          <% if (typeof connect !== 'undefined' && connect && (!connect.hasAccount || !connect.payoutsEnabled)) { %>
    <div class="card error" style="background:#fffaf0; border:1px solid #ffe6b3; padding:12px; margin:12px 0;">
      <strong>（オーナー向けの注意）</strong><br>
      この商品は売上の受取設定が完了していません。<br>
      <a href="/connect/onboard">こちら</a> から Stripe で振込口座の登録を行ってください。
    </div>
  <% } %>

<form id="checkoutForm" action="/checkout/<%= item.slug %>" method="post" target="_top" novalidate>
  <input type="hidden" name="_csrf" value="<%= csrfToken %>">
  <button id="checkoutBtn" class="btn primary" type="submit" aria-live="polite">
    <%= t('product.buy_button') %>
  </button>
</form>
  
<section class="card section-license">
<h3 class="section-title"><%= t('product.license_h2') %></h3>

  <div class="license-badge">
    <span class="pill"><%= licenseView.label %></span>
  </div>

  <p class="license-desc"><%= licenseView.desc %></p>

  <% if (item.licenseNotes) { %>
    <p class="license-notes"><%= item.licenseNotes %></p>
  <% } %>

  <% if (item.aiGenerated) { %>
    <p class="license-ai">※ 生成AI作品（モデル名：<%= item.aiModelName || '—' %>）</p>
  <% } %>

<p class="license-policy">
  <%- t('product.license_notice_html') %>
</p>
</section>

        <p class="hint">決済はStripe（カード）で安全に処理されます。</p>
      </div>
    </article>
  </main>

<script nonce="<%= cspNonce %>">

(function(){
  var opener = document.getElementById('openViewer');
  var modal  = document.getElementById('viewer');
  if(!opener || !modal) return;

  var btnClose = modal.querySelector('.lightbox__close');
  var btnFit   = modal.querySelector('.lightbox__fit');
  var img      = document.getElementById('viewerImg');
  var srcFull  = "/view/<%= item.slug %>";   // 等倍生成エンドポイント
  var fitMode  = false; // false=等倍, true=画面フィット

  // 事前プリロードで初回の空白を防ぐ
  var pre = new Image(); pre.src = srcFull;

  function applyMode(){
    if (fitMode) {
      img.style.maxWidth  = "100%";
      img.style.maxHeight = "100%";
      img.style.width = "auto"; img.style.height = "auto";
      btnFit && btnFit.setAttribute('aria-pressed','true');
    } else {
      img.style.maxWidth  = "none";   // ← 等倍の要点
      img.style.maxHeight = "none";
      img.style.width = "auto"; img.style.height = "auto";
      btnFit && btnFit.setAttribute('aria-pressed','false');
    }
  }

  function show(){
    if (img.getAttribute('src') !== srcFull) img.setAttribute('src', srcFull);
    fitMode = false; applyMode();     // いつも等倍で開く
try {
    var url = '/view/<%= item.slug %>?t=' + Date.now(); // キャッシュ回避
    var img = modal.querySelector('.lightbox__img');
    if (img && img.src !== url) img.src = url;
  } catch(_) {}
  modal.hidden = false;
  document.body.style.overflow = 'hidden';

    var inner = modal.querySelector('.lightbox__inner');
    if (inner) inner.scrollTo({left:0, top:0, behavior:'auto'}); // 左上から開始
  }

  function hide(){
    modal.hidden = true;
    document.body.style.overflow = '';
  }

  opener.addEventListener('click', function(e){ e.preventDefault(); show(); });
  btnClose.addEventListener('click', hide);
  modal.addEventListener('click', function(e){ if(e.target === modal) hide(); });
  window.addEventListener('keydown', function(e){ if(e.key === 'Escape') hide(); });

  // ダブルタップ/ダブルクリックで 等倍⇄フィット
  var lastTap = 0;
  modal.addEventListener('touchend', function(e){
    var now = Date.now();
    if (now - lastTap < 350) { fitMode = !fitMode; applyMode(); e.preventDefault(); }
    lastTap = now;
  }, {passive:false});
  modal.addEventListener('dblclick', function(){ fitMode = !fitMode; applyMode(); });

  btnFit && btnFit.addEventListener('click', function(){ fitMode = !fitMode; applyMode(); });
})();

</script>

<%- include('partials/footer') %>

<script nonce="<%= cspNonce %>">
  (function(){
    var sel = document.getElementById('langSelect');
    if(!sel) return;
    sel.addEventListener('change', function(){
      try { sel.form.submit(); } catch(_) {}
    });
  })();
</script>

<script nonce="<%= cspNonce %>">
  (function () {
    var form = document.getElementById('checkoutForm');
    var btn  = document.getElementById('checkoutBtn');
    if (!form || !btn) return;

    // 二度押し防止 & 視覚的なフィードバック
    form.addEventListener('submit', function () {
      try {
        btn.disabled = true;
        btn.style.opacity = '0.75';
      } catch (_) {}
      // 念のため、最上位フレームへ遷移を強制（iOSアプリ内ブラウザ対策）
      try {
        form.setAttribute('target', '_top');
      } catch (_) {}
    }, { once: true });
  })();
</script>

</body>
</html>

