<!doctype html>
<html lang="<%= lng || 'ja' %>">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
<title><%= t('upload.title_full') %></title>

<link rel="stylesheet" href="/public/style.css?v=<%= assetVer %>" />
<link rel="icon" href="/public/logo.png?v=<%= assetVer %>" />

</head>

<body class="layout">

<%- include('partials/header') %>
  
  <main class="container">

<h1><%= t('upload.h1') %></h1>

<%
// i18nを簡易対応（辞書を増やさず、lngで文言を出し分け）
const _okTitle   = (lng==='en') ? 'Payout setup completed' : '受取設定は完了しています';
const _okDesc    = (lng==='en') ? 'You can receive payouts. You can review / update settings from the button below.' : '売上の受け取りが可能です。必要に応じて下のボタンから設定を確認・更新できます。';
const _okBtn     = (lng==='en') ? 'Open Stripe dashboard' : '売上の確認 / 登録口座の変更';

const _ngTitle   = (lng==='en') ? 'Payout setup required' : '受取設定が未完了です';
const _ngDesc1   = (lng==='en') ? 'To receive payouts, you need to register a bank account and complete identity verification on Stripe.' : '売上の受け取りには、振込口座の登録（Stripe）と本人確認が必要です。';
const _ngBtn     = (lng==='en') ? 'Get started (Stripe)' : 'はじめる（Stripe）';
%>

<% if (typeof connect !== 'undefined' && connect && connect.hasAccount && connect.payoutsEnabled) { %>
  <!-- ✅ 完了カード -->
  <section class="status-card status-card--success">
    <div class="status-card__inner">
      <div class="status-card__icon">✅</div>
      <div class="status-card__body">
        <div class="status-card__title"><%= _okTitle %></div>
        <p class="status-card__desc"><%= _okDesc %></p>
        <a class="btn btn--primary" href="/connect/portal"><%= _okBtn %></a>
      </div>
    </div>
  </section>
<% } else { %>
  <!-- ⚠️ 未完了カード -->
  <section class="status-card status-card--warning">
    <div class="status-card__inner">
      <div class="status-card__icon">⚠️</div>
      <div class="status-card__body">
        <div class="status-card__title"><%= _ngTitle %></div>
        <p class="status-card__desc"><%= _ngDesc1 %></p>
        <a class="btn btn--primary" href="/connect/onboard"><%= _ngBtn %></a>
      </div>
    </div>
  </section>
<% } %>

<form action="/upload" method="post" enctype="multipart/form-data" autocomplete="off">

      <!-- CSRF token -->
  <input type="hidden" name="_csrf" value="<%= csrfToken %>">

  <p class="pageLead"><%= (lng === 'en') ? 'Upload an image, set a price, and get a shareable sales URL.' : '画像をアップロードして、価格を設定すると販売ページURLが発行されます。' %></p>

  <div class="formGrid">
    <section class="card formCard formCard--primary">
      <h2 class="formSectionTitle"><%= (lng === 'en') ? 'Sale data' : '販売データ' %></h2>

      <div class="fileField">
        <label><%= t('upload.field.file') %></label>
        <div class="fileRow">
          <input id="imageInput" class="fileInput" type="file" name="image" accept="image/*" required />
          <label for="imageInput" class="fileBtn"><%= (lng === 'en') ? 'Choose file' : 'ファイルを選ぶ' %></label>
          <div id="imageFileName" class="fileName"><%= (lng === 'en') ? 'No file selected' : '未選択' %></div>
        </div>
      </div>

      <label><%= t('upload.field.title') %>
        <input type="text" name="title" placeholder="<%= t('upload.field.title_ph') %>" required />
      </label>

      <label><%= t('upload.field.creator') %>
        <input type="text" name="creatorName" placeholder="<%= t('upload.field.creator_ph') %>" />
      </label>

      <div class="priceRow" id="priceRow"
           data-rate="<%= (typeof platformFeePct !== 'undefined' ? platformFeePct : 20) %>">

        <label class="priceCol priceCol--wide">
          <span class="priceLabel"><%= t('upload.price.price') %></span>
          
          <input id="priceInput" type="number" name="price"
                 min="<%= (typeof minPrice === 'number' ? minPrice : 300) %>"
                 step="1"
                 placeholder="¥<%= (typeof minPrice === 'number' ? minPrice : 300) %>〜"
                 inputmode="numeric"
                 autocomplete="off"
                 required />

        </label>

        <div class="op">−</div>

        <div class="priceCol">
          <span class="priceLabel">
            <%= t('upload.price.fee') %>（<span id="feeRateText"></span>）
          </span>
          <input id="feeVal" type="text" class="readonlyBox" value="¥0" readonly aria-readonly="true" />
        </div>

        <div class="op">＝</div>

        <div class="priceCol priceCol--wide">
          <span class="priceLabel"><%= t('upload.price.profit') %></span>
          <input id="profitVal" type="text" class="readonlyBox readonlyBox--em" value="¥0" readonly aria-readonly="true" />
        </div>

        <input type="hidden" name="currency" value="jpy" />
      </div>
    </section>

    <section class="card formCard formCard--confirm">
      <h2 class="formSectionTitle"><%= (lng === 'en') ? 'Confirmation' : '確認' %></h2>

      <label>
        <input type="checkbox" name="attestOwner" required />
        <%= t('upload.attest') %>
      </label>

      <label>
        <input type="checkbox" name="agreeTerms" required />
        <%- t('upload.agree_terms_html') %>
      </label>
    </section>

    <section class="card formCard formCard--license">
      <h2 class="formSectionTitle"><%= t('upload.license.h2') %></h2>

      <div class="licenseList">
        <label class="licenseRow">
          <!-- ※ バックエンドは 'editorial' を期待。現状 'personal' だったので修正 -->
          <input type="radio" name="licensePreset" value="editorial" checked>
          <div class="licenseMain">
            <div class="licenseTitle"><%= t('upload.license.editorial.title') %></div>
            <div class="licenseDesc"><%= t('upload.license.editorial.desc') %></div>
          </div>
        </label>

        <label class="licenseRow">
          <input type="radio" name="licensePreset" value="standard">
          <div class="licenseMain">
            <div class="licenseTitle"><%= t('upload.license.standard.title') %></div>
            <div class="licenseDesc"><%= t('upload.license.standard.desc') %></div>
          </div>
        </label>

        <label class="licenseRow">
          <input type="radio" name="licensePreset" value="commercial-lite">
          <div class="licenseMain">
            <div class="licenseTitle"><%= t('upload.license.commercial_lite.title') %></div>
            <div class="licenseDesc"><%= t('upload.license.commercial_lite.desc') %></div>
          </div>
        </label>

        <label class="licenseRow">
          <input type="radio" name="licensePreset" value="exclusive">
          <div class="licenseMain">
            <div class="licenseTitle"><%= t('upload.license.exclusive.title') %></div>
            <div class="licenseDesc"><%= t('upload.license.exclusive.desc') %></div>
          </div>
        </label>
      </div>

      <p class="muted">
        <%- t('upload.license.notice_html') %>
      </p>
    </section>
  </div>

  <div class="formFooter">
    <button type="submit" class="btn btn--primary"><%= t('upload.submit') %></button>
  </div>

</form>

  </main>

<%- include('partials/footer') %>

<!-- 作成中モーダル（共通クラス版：スマホでも確実に全画面） -->
<div id="progressModal" class="modal" aria-hidden="true">
  <div class="modal__panel" role="dialog" aria-modal="true" aria-labelledby="progressTitle">
    
<div class="modalProgress" id="modalProgress">
<h3 id="progressTitle" class="modal__title"><%= t('upload.modal.title') %></h3>
<p id="progressPhase" class="modal__phase"><%= t('upload.modal.phase_uploading') %></p>

    <div class="progress">
      <div id="progressBar" class="progress__bar"></div>
    </div>
    <p id="progressPct" class="progress__pct">0%</p>
</div>

<div id="resultInModal" class="modal__result">
  <div class="modal__result-title"><%= t('upload.modal.created') %></div>

  <div class="modalDivider"></div>
  <section class="modalBlock" aria-label="sale-page-url">
    <div class="modalBlock__title"><%= (lng === 'en') ? 'Sale page URL' : '販売ページURL' %></div>
    <div class="modalUrlRow">
      <input id="resultUrlInModal" type="text" readonly>
      <button type="button" id="copyResultUrl" class="btn btn--primary"><%= (lng === 'en') ? 'Copy' : 'コピー' %></button>
    </div>
  </section>

  <div class="modalDivider"></div>
  <section class="modalBlock" aria-label="post-template">
    <div class="modalBlock__title"><%= (lng === 'en') ? 'Post text' : '投稿文テンプレ' %></div>
    <div class="tweet-controls">
      <label for="tweetTemplate"><%= (lng === 'en') ? 'Post text template' : '投稿文テンプレ' %></label>
      <select id="tweetTemplate">
        <% if (lng === 'en') { %>
          <option value="promo">Promotion (Standard)</option>
          <option value="support">Support request (Buy to support)</option>
          <option value="limited">Limited feel (today/limited quantity)</option>
        <% } else { %>
          <option value="promo">宣伝（標準）</option>
          <option value="support">支援お願い（応援購入）</option>
          <option value="limited">限定感（本日限定/数量限定風）</option>
        <% } %>
      </select>
      <textarea id="tweetText" rows="5"></textarea>
      <button type="button" id="copyTweetText" class="btn btn--primary"><%= (lng === 'en') ? 'Copy post text' : '本文をコピー' %></button>
      <small><%= (lng === 'en') ? 'Feel free to edit before posting.' : '必要なら投稿前に編集してOKです。' %></small>
    </div>
  </section>

  <div class="modalDivider"></div>
  <section class="modalBlock" aria-label="actions">
    <div class="modalBlock__title"><%= (lng === 'en') ? 'Actions' : '操作' %></div>
    <div class="modal__result-actions">

<a id="tweetOnX" class="btn btn--primary" href="#" target="_blank" rel="noopener">
  <img src="/public/x-icon.png" alt="X">
  <% if (lng === 'en') { %>
    <span>Sell on</span>
  <% } else { %>
    <span>で販売する</span>
  <% } %>
</a>

<a id="openResultUrl" class="btn btn--primary" href="#" target="_blank" rel="noopener"><%= t('upload.modal.btn_open_sale') %></a>
<button type="button" id="closeModal" class="btn btn--ghost"><%= t('upload.modal.btn_close') %></button>

    </div>
  </section>

  <p class="muted"><%= t('upload.modal.hint') %></p>

</div>
  </div>
</div>

<script nonce="<%= cspNonce %>">
(function() {
  const form = document.querySelector('form[action="/upload"]');
  if (!form) return;

    // ---- i18n strings injected from server ----
  const I18N = {
    uploading  : "<%= t('upload.modal.phase_uploading') %>",
    processing : "<%= t('upload.modal.phase_processing') %>",
    done       : "<%= t('upload.modal.done') %>",
    created    : "<%= t('upload.modal.created') %>",
    btnOpen    : "<%= t('upload.modal.btn_open_sale') %>",
    btnCopy    : "<%= t('upload.modal.btn_copy') %>",
    copied     : "<%= t('upload.modal.copied') %>",
    btnClose   : "<%= t('upload.modal.btn_close') %>",
    title      : "<%= t('upload.modal.title') %>",
    hint       : "<%= t('upload.modal.hint') %>"
  };

  // クライアント側で言語を使えるように（en/ja）
const LNG = "<%= (lng || 'ja') %>";
let lastCreatedUrl = "";

const imageInput = document.getElementById('imageInput');
const imageFileName = document.getElementById('imageFileName');
const emptyFileLabel = (LNG === 'en') ? 'No file selected' : '未選択';
if (imageInput && imageFileName) {
  const syncFileName = () => {
    const f = imageInput.files && imageInput.files[0];
    imageFileName.textContent = f ? f.name : emptyFileLabel;
  };
  imageInput.addEventListener('change', syncFileName);
  syncFileName();
}

  // === 横一列UI：価格 → 手数料 → 利益 のリアルタイム計算 ===
  const priceInput = document.getElementById('priceInput');
  const row        = document.getElementById('priceRow');
  const feeRate    = row ? (Number(row.dataset.rate) || 20) : 20; // %
  const feeRateTextEl = document.getElementById('feeRateText');
  const feeValEl      = document.getElementById('feeVal');
  const profitValEl   = document.getElementById('profitVal');

  function jpy(n){ return '¥' + (isFinite(n) ? Math.max(0, Math.floor(n)).toLocaleString('ja-JP') : '0'); }

  function recalc(){
    const price = Number(priceInput?.value || 0);
    if (!isFinite(price) || price <= 0){
      feeValEl.value    = '¥0';
      profitValEl.value = '¥0';
      return;
    }
    const fee    = Math.floor(price * (feeRate / 100)); // 端数切り捨て
    const profit = price - fee;                          // 決済手数料の控除方針は運用に合わせて調整
    feeValEl.value    = jpy(fee);
    profitValEl.value = jpy(profit);
  }

  if (feeRateTextEl) feeRateTextEl.textContent = feeRate + '%';

  function buildTweetText(templateType, createdUrl) {
    const isEn = LNG === 'en';
    const hashtags = isEn
      ? ['#AIart', '#AIillustration', '#DigitalArt', '#ArtForSale']
      : ['#AIイラスト', '#AI画像', '#AIart', '#画像販売'];

    const lineMap = isEn
      ? {
          promo: [
            'My AI artwork is now on sale.',
            'Buy in high resolution and compare with SAMPLE watermark preview.',
            createdUrl
          ],
          support: [
            'If you like my AI artwork, please support me with a purchase.',
            'You will get a high-resolution file (cleaner than SAMPLE watermark preview).',
            createdUrl
          ],
          limited: [
            'Limited release today for my AI artwork.',
            'Get the high-resolution version (SAMPLE watermark is preview only).',
            createdUrl
          ]
        }
      : {
          promo: [
            'AI作品を出品しました。',
            '購入すると高解像度版を入手できます（SAMPLE透かしはプレビュー用）。',
            createdUrl
          ],
          support: [
            'このAI作品を気に入っていただけたら、応援購入してもらえると嬉しいです。',
            '高解像度で購入でき、SAMPLE透かしなしの本編を楽しめます。',
            createdUrl
          ],
          limited: [
            '本日限定の気分でAI作品を公開中。',
            '高解像度で購入可能（SAMPLE透かしはプレビューのみ）。',
            createdUrl
          ]
        };

    const maxLen = 270;
    const lines = lineMap[templateType] || lineMap.promo;

    for (let tagCount = hashtags.length; tagCount >= 0; tagCount -= 1) {
      const tagLine = hashtags.slice(0, tagCount).join(' ');
      const text = tagLine ? lines.concat([tagLine]).join('\n') : lines.join('\n');
      if (text.length < maxLen) return text;
    }

    const fallback = lines.join('\n');
    return fallback.slice(0, Math.max(0, maxLen - 1));
  }

  function resetLicensePreset() {
    const defaultRadio = form.querySelector('input[name="licensePreset"][value="editorial"]');
    if (defaultRadio) defaultRadio.checked = true;
  }

  if (priceInput){
  // 先にクリア（オートフィルや履歴復元の値を消す）
  try { priceInput.value = ''; } catch(_) {}
  ['input','change','blur'].forEach(ev => priceInput.addEventListener(ev, recalc));
  recalc(); // 初期表示（¥0/¥0 表示）
}

  form.addEventListener('submit', function (ev) {
    // ★ 先にネイティブバリデーションを実行。NGなら送信しない
    if (!form.reportValidity()) {
      return; // ブラウザがどの項目かハイライトしてくれる
    }

    ev.preventDefault(); // ← バリデーション通過後に抑止

      // 価格の最小値をもう一段階チェック（堅牢化）
  const minVal = Number(priceInput?.getAttribute('min') || 300);
  const nowVal = Number(priceInput?.value || 0);

if (nowVal < minVal) {
  alert((LNG === 'en') ? `The minimum listing price is ${minVal} JPY.` : `出品価格は${minVal}円以上で設定してください。`);
  return;
}

    const modal = document.getElementById('progressModal');
    const bar   = document.getElementById('progressBar');
    const pct   = document.getElementById('progressPct');
    const phase = document.getElementById('progressPhase');
    const modalProgress = document.getElementById('modalProgress');

const resultBox = document.getElementById('ajaxResultBox');      // あってもなくてもOK
// const resultUrl = document.getElementById('ajaxResultUrl');   // 未使用なら削除でOK

if (!modal || !bar || !pct || !phase) {
  form.submit(); // モーダル要素が無いときだけフォールバック
  return;
}

if (resultBox) resultBox.style.display = 'none';
bar.style.width = '0%';

pct.textContent = '0%';
phase.textContent = I18N.uploading;
if (modalProgress) modalProgress.classList.remove('is-hidden');

modal.style.display = 'flex';
document.body.classList.add('modal-open');   // ← 追加（スマホで背景を止める）

    // ★ 追加：二重送信防止（送信ボタンの無効化と文言変更）
    const submitBtn = form.querySelector('button[type="submit"]');
    if (submitBtn && !submitBtn.disabled) {

submitBtn.dataset.origText = submitBtn.textContent || '';
submitBtn.disabled = true;
submitBtn.textContent = (submitBtn.dataset.origText || "<%= t('upload.submit') %>") + '…';

    }

    const fd = new FormData(form);
    const xhr = new XMLHttpRequest();

xhr.open('POST', form.action);
xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
// CSRFヘッダ（bodyの_hiddenと二重で送る）
try {
  var csrf = form.querySelector('input[name="_csrf"]')?.value || '';
  if (csrf) xhr.setRequestHeader('X-CSRF-Token', csrf);
} catch(_) {}

    xhr.upload.onprogress = function (e) {
      if (!e.lengthComputable) return;
      const p = Math.min(70, Math.floor((e.loaded / e.total) * 70));
      bar.style.width = p + '%';
      pct.textContent = p + '%';
    };

    xhr.upload.onload = function () {
phase.textContent = I18N.processing;
      let v = parseInt(bar.style.width) || 70;
      const timer = setInterval(() => {
        if (v >= 95) return clearInterval(timer);
        v += 1;
        bar.style.width = v + '%';
        pct.textContent = v + '%';
      }, 120);
    };

    xhr.onreadystatechange = function () {
      if (xhr.readyState !== 4) return;

      // ★ JSON以外が返ってきた（認証リダイレクト/エラーページ）場合も安全に処理
      let res = {};
      try { res = JSON.parse(xhr.responseText || '{}'); } catch (_) { res = {}; }

      if (xhr.status >= 200 && xhr.status < 300 && res.ok && res.createdUrl) {
phase.textContent = I18N.done;
        bar.style.width = '100%';
        pct.textContent = '100%';

setTimeout(() => {
  // モーダルは開いたまま、完了表示に切替
phase.textContent = I18N.done;
  bar.style.width = '100%';
  pct.textContent = '100%';

if (resultBox) resultBox.style.display = 'none';

  // ★ モーダル内に結果を表示
  const resultWrap = document.getElementById('resultInModal');
  const resultInput = document.getElementById('resultUrlInModal');
  const openBtn = document.getElementById('openResultUrl');
  const closeBtn = document.getElementById('closeModal');
  const copyBtn  = document.getElementById('copyResultUrl');
  const copyTweetBtn = document.getElementById('copyTweetText');
  const tweetText = document.getElementById('tweetText');
  const tweetTemplate = document.getElementById('tweetTemplate');
  const tweetBtn = document.getElementById('tweetOnX'); // ← 追加

  if (resultWrap && resultInput && openBtn) {
    resultInput.value = res.createdUrl;
    openBtn.href = res.createdUrl;
    if (modalProgress) modalProgress.classList.add('is-hidden');
    resultWrap.style.display = 'block';

    const syncTweetIntent = () => {
      if (!tweetBtn || !tweetText) return;
      const intent = 'https://x.com/intent/tweet?text=' + encodeURIComponent(tweetText.value || '');
      tweetBtn.href = intent;
    };

    lastCreatedUrl = res.createdUrl;

    if (tweetTemplate && tweetText) {
      tweetTemplate.value = 'promo';
      tweetText.value = buildTweetText(tweetTemplate.value, lastCreatedUrl);
      tweetTemplate.onchange = () => {
        tweetText.value = buildTweetText(tweetTemplate.value, lastCreatedUrl);
        syncTweetIntent();
      };
      tweetText.oninput = syncTweetIntent;
      syncTweetIntent();
    }

    if (tweetBtn) {
      tweetBtn._syncTweetIntent = syncTweetIntent;
      if (!tweetBtn.dataset.intentSyncBound) {
        tweetBtn.addEventListener('click', () => {
          if (typeof tweetBtn._syncTweetIntent === 'function') tweetBtn._syncTweetIntent();
        });
        tweetBtn.dataset.intentSyncBound = '1';
      }
    }

    // コピーボタン（毎回多重にイベントが付かないよう一旦初期化）
    if (copyBtn) {
      copyBtn.onclick = null;
      copyBtn.onclick = async () => {
        try {
          await navigator.clipboard.writeText(res.createdUrl);
copyBtn.textContent = I18N.copied;
setTimeout(() => (copyBtn.textContent = I18N.btnCopy), 1200);
        } catch (_) {
          resultInput.select();
          document.execCommand('copy');
        }
      };
    }

    if (copyTweetBtn && tweetText) {
      copyTweetBtn.onclick = null;
      copyTweetBtn.onclick = async () => {
        try {
          await navigator.clipboard.writeText(tweetText.value || '');
          copyTweetBtn.textContent = I18N.copied;
          setTimeout(() => {
            copyTweetBtn.textContent = (LNG === 'en') ? 'Copy post text' : '本文をコピー';
          }, 1200);
        } catch (_) {
          tweetText.select();
          document.execCommand('copy');
        }
      };
    }

    // 閉じる → モーダル閉じてフォームだけ初期化
    if (closeBtn) {
closeBtn.onclick = () => {
  modal.style.display = 'none';
  document.body.classList.remove('modal-open'); // 背景ロック解除
  resultWrap.style.display = 'none';
  if (modalProgress) modalProgress.classList.remove('is-hidden');
  bar.style.width = '0%';
  pct.textContent = '0%';
  phase.textContent = I18N.uploading;
  if (tweetTemplate) tweetTemplate.value = 'promo';
  if (tweetText) tweetText.value = buildTweetText('promo', lastCreatedUrl);
};
    }
  }

  // フォームの軽いリセット
  const file = form.querySelector('input[type="file"]');
  if (file) file.value = '';
  form.querySelectorAll('input[type="checkbox"]').forEach((chk) => {
    chk.checked = false;
  });
  if (priceInput) priceInput.value = '';
  recalc();
  resetLicensePreset();

  // 送信ボタンを復帰
  const submitBtn = form.querySelector('button[type="submit"]');
  if (submitBtn) {
    submitBtn.disabled = false;
submitBtn.textContent = submitBtn.dataset.origText || "<%= t('upload.submit') %>";

  }
}, 350);

} else {
  modal.style.display = 'none';
  document.body.classList.remove('modal-open'); // 背景ロック解除

        // ★ 追加：ボタンを復帰
        (function restoreBtn() {
          const submitBtn = form.querySelector('button[type="submit"]');
          if (submitBtn) {
            submitBtn.disabled = false;
submitBtn.textContent = submitBtn.dataset.origText || "<%= t('upload.submit') %>";

          }
        })();

        // 認証が切れていたときはアップロードページに戻す
        if (xhr.status === 401 || /login/i.test(xhr.responseText || '')) {
          alert('ログインが必要です。ログインページへ移動します。');
          location.href = '/login';
          return;
        }
        alert((res && res.message) || 'アップロードに失敗しました。しばらくして再度お試しください。');

      }
    };

xhr.onerror = function () {
  modal.style.display = 'none';
  document.body.classList.remove('modal-open'); // 背景ロック解除

  // ★ 追加：ボタンを復帰
  const submitBtn = form.querySelector('button[type="submit"]');
  if (submitBtn) {
    submitBtn.disabled = false;
submitBtn.textContent = submitBtn.dataset.origText || "<%= t('upload.submit') %>";

  }

  alert('ネットワークエラーが発生しました。通信環境をご確認ください。');
};

    xhr.send(fd);
  });
})();
</script>

<script nonce="<%= cspNonce %>">
(function () {
  try {
    var current = location.pathname + location.search + location.hash;
    var ret = encodeURIComponent(current);

    // 1) ヘッダーに「/lang」フォームがある場合は hidden を付与/更新
    document.querySelectorAll('form[action="/lang"]').forEach(function(f){
      // 既に無ければ hidden を作る
      var hid = f.querySelector('input[name="return"]');
      if (!hid) {
        hid = document.createElement('input');
        hid.type = 'hidden';
        hid.name = 'return';
        f.appendChild(hid);
      }
      hid.value = current;

      // セレクトの change で即 submit（備え）
      var sel = f.querySelector('select[name="lng"]');
      if (sel && !sel.dataset._bound) {
        sel.dataset._bound = '1';
        sel.addEventListener('change', function(){ try { f.submit(); } catch(_) {} });
      }
    });

    // 2) 言語リンク（/lang?lng=xx）を使っている場合は &return= を後付け
    document.querySelectorAll('a[href^="/lang?lng="]').forEach(function(a){
      if (!/(\?|&)return=/.test(a.search)) {
        a.href = a.href + (a.search ? '&' : '?') + 'return=' + ret;
      }
    });
  } catch(_) {}
})();
</script>

</body>
</html>
